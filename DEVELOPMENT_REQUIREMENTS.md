# Refly 二次开发需求文档

## 📋 项目概述

本文档记录 Refly 项目的二次开发需求、技术分析思路以及代码质量原则，确保开发过程的规范性和可追溯性。

## 🎯 开发原则

### 代码质量原则
1. **可维护性优先**: 所有修改都应考虑后续维护成本
2. **配置驱动**: 通过配置文件或环境变量控制功能开关，避免硬编码
3. **向后兼容**: 新功能不应破坏现有功能
4. **模块化设计**: 功能模块独立，降低耦合度
5. **文档完整**: 重大修改需要更新相关文档

### 技术规范
- 遵循 TypeScript 严格模式
- 使用 ESLint + Prettier 保证代码风格统一
- 组件采用函数式组件 + Hooks
- 状态管理使用 Zustand + React Query
- 样式使用 Tailwind CSS + 语义化类名
- 国际化支持中英双语

## 📝 需求列表

### 需求 #001: 修改首页为登录注册页面

**需求描述**: 
将项目首页从当前的营销展示页面改为直接显示登录注册页面

**当前行为**:
- 访问根路径 `/` 时，未登录用户看到营销首页（包含产品介绍、功能展示等）
- 已登录用户自动重定向到 `/canvas/empty`

**期望行为**:
- 访问根路径 `/` 时，未登录用户直接看到登录注册页面
- 已登录用户行为保持不变，重定向到工作区

**影响范围**:
- 路由配置 (`apps/web/src/routes/index.tsx`)
- 首页重定向逻辑 (`packages/ai-workspace-common/src/components/home-redirect/index.tsx`)
- 可能需要保留营销页面的访问路径

**技术分析**:

1. **核心修改点**:
   - `HomeRedirect` 组件逻辑需要调整
   - 需要决定营销页面的新路径（如 `/landing` 或 `/about`）

2. **实现方案**:
   - 方案A: 直接修改 `HomeRedirect` 组件，未登录时显示登录页面
   - 方案B: 添加配置项控制首页行为，保持灵活性
   - **推荐方案B**: 通过环境变量控制，便于后续调整

3. **代码变更预估**:
   - 修改文件: 2-3 个
   - 新增配置: 1 个环境变量
   - 测试范围: 登录流程、路由跳转

**道德/合规考虑**:
- ✅ 不涉及数据隐私问题
- ✅ 不影响用户数据安全
- ✅ 符合用户体验改进目标
- ⚠️ 需考虑SEO影响（营销页面对搜索引擎的可见性）

**优先级**: 高
**预估工时**: 0.5 天
**状态**: 已完成

**实现详情**:
1. ✅ 创建独立的登录页面组件 (`apps/web/src/pages/auth/index.tsx`)
2. ✅ 修改 `HomeRedirect` 组件支持配置驱动行为
3. ✅ 添加新路由配置:
   - `/auth` - 独立登录注册页面
   - `/landing` - 原营销页面的新路径
   - `/` - 根据配置显示登录页面或营销页面
4. ✅ 添加环境变量 `VITE_HOMEPAGE_SHOW_AUTH` 控制首页行为

**使用方法**:
- 设置环境变量 `VITE_HOMEPAGE_SHOW_AUTH=true` 启用登录首页
- 设置环境变量 `VITE_HOMEPAGE_SHOW_AUTH=false` 或不设置保持原有行为
- 访问 `/landing` 可直接查看营销页面
- 访问 `/auth` 可直接进入登录页面

---

## 🔄 需求状态说明

- **待开始**: 需求已确认，等待开发
- **进行中**: 正在开发实现
- **待测试**: 开发完成，等待测试验证
- **已完成**: 测试通过，已部署
- **已取消**: 需求取消或废弃

## 📋 需求分析模板

每个新需求应包含以下信息：

### 基本信息
- **需求ID**: #XXX
- **需求标题**: 简洁描述
- **提出时间**: YYYY-MM-DD
- **优先级**: 高/中/低

### 需求详情
- **需求描述**: 详细说明期望实现的功能
- **当前行为**: 现有系统的行为表现
- **期望行为**: 修改后期望达到的效果
- **用户价值**: 此需求对用户的价值

### 技术分析
- **影响范围**: 列出可能受影响的模块/文件
- **技术方案**: 详细的实现方案
- **技术风险**: 可能遇到的技术难点
- **性能影响**: 对系统性能的影响评估

### 合规检查
- **数据隐私**: 是否涉及用户数据处理
- **安全风险**: 是否引入新的安全风险
- **法律合规**: 是否符合相关法律法规
- **商业道德**: 是否符合商业道德标准

### 项目管理
- **依赖关系**: 与其他需求的依赖关系
- **预估工时**: 开发时间预估
- **测试要求**: 测试范围和重点
- **发布计划**: 预期发布时间

## 🧪 测试指南

### 需求 #001 测试步骤

1. **默认行为测试** (营销首页):
   ```bash
   # 不设置环境变量或设置为 false
   VITE_HOMEPAGE_SHOW_AUTH=false pnpm dev
   # 访问 http://localhost:5173/ 应显示营销页面
   ```

2. **登录首页测试**:
   ```bash
   # 设置环境变量为 true
   VITE_HOMEPAGE_SHOW_AUTH=true pnpm dev
   # 访问 http://localhost:5173/ 应显示登录页面
   ```

3. **路由测试**:
   - 访问 `/auth` - 应始终显示登录页面
   - 访问 `/landing` - 应始终显示营销页面
   - 已登录用户访问 `/` - 应重定向到 `/canvas/empty`

4. **功能测试**:
   - 登录页面的注册/登录切换
   - OAuth 登录按钮（如果启用）
   - 邮箱登录表单验证
   - "返回首页"按钮功能

## 🚀 下一步行动

1. ✅ **需求 #001**: 首页修改已完成
2. **用户验收测试**: 确认新的登录首页用户体验
3. **性能测试**: 验证新组件的加载性能
4. **文档更新**: 更新部署文档中的环境变量说明

## 📚 相关文档

- [项目架构文档](./README.md)
- [贡献指南](./CONTRIBUTING.md)
- [部署文档](./docs/community-version/self-deploy/)

---

*文档创建时间: 2024-12-19*
*最后更新时间: 2024-12-19*

## 📈 开发进度总结

- **需求总数**: 1
- **已完成**: 1 
- **进行中**: 0
- **待开始**: 0
- **完成率**: 100% 

## 📚 开发教训记录

### 教训 #001: CSS布局理解错误 (2024-12-19)

**错误行为**:
在修复登录页面logo与表单距离问题时，错误地认为调整容器高度(h-[80px] -> h-[120px] -> h-[60px] -> h-[40px])可以解决间距问题，并且在用户明确指出错误后仍然执迷不悟，继续在错误的方向上进行调整。

**根本问题**:
- **缺乏CSS基础理解**: 没有理解flex布局中`justify-center`的作用机制
- **忽略用户反馈**: 用户明确说"改变高度解决不了问题"，但仍然坚持错误方向
- **缺乏实际查看**: 没有要求查看实际效果，凭空臆测
- **教条主义**: 过分依赖理论知识，缺乏实践验证

**正确解决方案**:
问题的核心是flex容器的对齐方式，而不是高度设置：
- `justify-center`: 让内容在主轴上居中
- `justify-start`: 让内容从起始位置开始排列
- 需要在保持整体居中的同时，合理安排内部元素间距

**经验教训**:
1. **尊重用户反馈**: 当用户明确指出技术方向错误时，应立即停止并重新分析
2. **理解问题本质**: 在CSS布局问题中，要准确识别是spacing、positioning还是alignment问题
3. **要求查看实际效果**: 进行UI修改时应该要求查看截图或实际效果
4. **承认知识盲点**: 遇到不确定的问题时，应该诚实地承认并寻求帮助
5. **学习优秀代码**: 参考现有的优秀实现(如用户提供的参考代码)比自己重新发明要高效得多

**避免策略**:
- 在进行CSS修改前，先理解当前布局的工作原理
- 用户提出技术纠正时，优先考虑用户的观点
- 对于UI问题，主动要求查看实际效果
- 学会识别自己的知识边界

**适用范围**: 所有涉及CSS布局、用户界面调整的开发任务 