# Refly 二次开发需求文档

## 📋 项目概述

本文档记录 Refly 项目的二次开发需求、技术分析思路以及代码质量原则，确保开发过程的规范性和可追溯性。

## 🚀 项目启动步骤

### 第一步：启动 Docker 服务
**在项目根目录** `/Users/longxiangyu/LexiHk/lexiAI` **执行：**

```bash
# 进入 docker 配置目录
cd deploy/docker

# 启动数据库和中间件服务
docker-compose -f docker-compose.yml -f docker-compose.middleware.yml up -d
```

### 第二步：安装依赖（如果还没安装过）
**回到项目根目录** `/Users/longxiangyu/LexiHk/lexiAI` **执行：**

```bash
# 回到根目录
cd ../..

# 安装所有依赖
pnpm install
```

### 第三步：启动后端 API
**在项目根目录** `/Users/longxiangyu/LexiHk/lexiAI` **执行：**

```bash
# 启动后端 API
pnpm run dev --filter=@refly/api
```

或者进入API目录启动：
```bash
# 进入 API 目录
cd apps/api

# 启动开发服务器
pnpm dev
```

### 第四步：启动前端
**新开一个终端窗口，在项目根目录** `/Users/longxiangyu/LexiHk/lexiAI` **执行：**

```bash
# 启动前端开发服务器
pnpm run dev --filter=@refly/web
```

或者进入web目录启动：
```bash
# 进入 web 目录
cd apps/web

# 启动开发服务器
pnpm dev
```

### 验证启动是否成功

1. **检查 Docker 容器**：
```bash
docker ps
```
应该看到数据库等服务在运行

2. **检查后端 API**：
浏览器访问 `http://localhost:3000` 或查看终端输出的端口

3. **检查前端应用**：
浏览器访问 `http://localhost:5173` 或查看终端输出的端口

### 启动顺序总结

```
项目根目录 /Users/longxiangyu/LexiHk/lexiAI
├── 1. cd deploy/docker && docker-compose up -d
├── 2. cd ../../ && pnpm install
├── 3. pnpm run dev --filter=@refly/api
└── 4. pnpm run dev --filter=@refly/web（新终端窗口）
```

**注意事项**：
- 必须按顺序启动：Docker → 后端 API → 前端
- 后端 API 需要连接数据库，数据库在 Docker 容器中运行
- 前端需要调用后端 API 获取用户信息、进行认证等
- 启动成功后，修改的功能（如语言切换、账户按钮）才能正常工作

## 🎯 开发原则

### 代码质量原则
1. **可维护性优先**: 所有修改都应考虑后续维护成本
2. **配置驱动**: 通过配置文件或环境变量控制功能开关，避免硬编码
3. **向后兼容**: 新功能不应破坏现有功能
4. **模块化设计**: 功能模块独立，降低耦合度
5. **文档完整**: 重大修改需要更新相关文档

### 技术规范
- 遵循 TypeScript 严格模式
- 使用 ESLint + Prettier 保证代码风格统一
- 组件采用函数式组件 + Hooks
- 状态管理使用 Zustand + React Query
- 样式使用 Tailwind CSS + 语义化类名
- 国际化支持中英双语

## 📝 需求列表

### 需求 #001: 修改首页为登录注册页面

**需求描述**: 
将项目首页从当前的营销展示页面改为直接显示登录注册页面

**当前行为**:
- 访问根路径 `/` 时，未登录用户看到营销首页（包含产品介绍、功能展示等）
- 已登录用户自动重定向到 `/canvas/empty`

**期望行为**:
- 访问根路径 `/` 时，未登录用户直接看到登录注册页面
- 已登录用户行为保持不变，重定向到工作区

**影响范围**:
- 路由配置 (`apps/web/src/routes/index.tsx`)
- 首页重定向逻辑 (`packages/ai-workspace-common/src/components/home-redirect/index.tsx`)
- 可能需要保留营销页面的访问路径

**技术分析**:

1. **核心修改点**:
   - `HomeRedirect` 组件逻辑需要调整
   - 需要决定营销页面的新路径（如 `/landing` 或 `/about`）

2. **实现方案**:
   - 方案A: 直接修改 `HomeRedirect` 组件，未登录时显示登录页面
   - 方案B: 添加配置项控制首页行为，保持灵活性
   - **推荐方案B**: 通过环境变量控制，便于后续调整

3. **代码变更预估**:
   - 修改文件: 2-3 个
   - 新增配置: 1 个环境变量
   - 测试范围: 登录流程、路由跳转

**道德/合规考虑**:
- ✅ 不涉及数据隐私问题
- ✅ 不影响用户数据安全
- ✅ 符合用户体验改进目标
- ⚠️ 需考虑SEO影响（营销页面对搜索引擎的可见性）

**优先级**: 高
**预估工时**: 0.5 天
**状态**: 已完成

**实现详情**:
1. ✅ 创建独立的登录页面组件 (`apps/web/src/pages/auth/index.tsx`)
2. ✅ 修改 `HomeRedirect` 组件支持配置驱动行为
3. ✅ 添加新路由配置:
   - `/auth` - 独立登录注册页面
   - `/landing` - 原营销页面的新路径
   - `/` - 根据配置显示登录页面或营销页面
4. ✅ 添加环境变量 `VITE_HOMEPAGE_SHOW_AUTH` 控制首页行为

**使用方法**:
- 设置环境变量 `VITE_HOMEPAGE_SHOW_AUTH=true` 启用登录首页
- 设置环境变量 `VITE_HOMEPAGE_SHOW_AUTH=false` 或不设置保持原有行为
- 访问 `/landing` 可直接查看营销页面
- 访问 `/auth` 可直接进入登录页面

### 需求 #002: 修改登录后首页左侧边栏样式

**需求描述**: 
修改用户登录后进入的首页（/canvas/empty）左侧边栏的视觉设计，主要包括logo替换、搜索框样式调整以及整体布局优化

**当前行为**:
- 侧边栏顶部显示 Refly logo + GitHub星标按钮
- 搜索框为简单的边框样式，带有⌘K快捷键提示
- 整体采用白色背景 + 灰色边框的设计

**期望行为**:
- 替换为新的 LexiHK logo：左侧方形深色图标 + "LexiHK"文字（其中K为绿色）
- 移除 GitHub 星标按钮，采用更简洁的logo布局
- 搜索框保持现有功能，可能需要微调样式以配合新的视觉风格
- 整体布局和间距保持一致，主要是品牌标识的替换

**影响范围**:
- `packages/ai-workspace-common/src/components/sider/layout.tsx` - 主要侧边栏布局组件
- `packages/ai-workspace-common/src/components/search-quick-open-btn/index.tsx` - 搜索框组件
- 可能需要新增logo资源文件
- CSS样式调整

**技术分析**:

1. **核心修改点**:
   - `SiderLogo` 组件: 替换logo图片和布局样式
   - `SearchQuickOpenBtn` 组件: 调整搜索框的视觉设计
   - 整体侧边栏容器样式调整

2. **实现方案**:
   - 方案A: 直接修改现有组件样式
   - 方案B: 创建新的样式变体，通过配置控制
   - **推荐方案A**: 直接替换，符合品牌升级需求

3. **详细变更点**:
   - Logo区域: 
     - 更换logo图片资源
     - 调整logo和文字的布局方式
     - 可能移除或重新设计GitHub星标按钮
   - 搜索框区域:
     - 修改边框样式和颜色
     - 调整内边距和圆角
     - 优化图标和文字的对齐方式
     - 重新设计hover效果
   - 整体布局:
     - 调整各区域间距
     - 可能需要调整侧边栏宽度
     - 优化色彩搭配

4. **具体设计要求**（基于效果图分析）:
   - Logo替换：
     - 左侧：方形深色图标（需要提供SVG或PNG素材）
     - 右侧：文字"LexiHK"，其中"Lexi"为深色，"K"为绿色
     - 移除GitHub星标按钮
   - 搜索框保持现有样式和功能
   - 整体布局间距保持一致
   - 需要确认：logo图标的具体素材文件

**道德/合规考虑**:
- ✅ 纯视觉样式修改，不涉及功能变更
- ✅ 不影响用户数据和隐私
- ✅ 符合品牌升级和用户体验改进目标
- ⚠️ 需确保新设计符合无障碍访问标准

**优先级**: 中
**预估工时**: 0.5-1 天（取决于设计复杂度）
**状态**: 已完成

**前置条件**:
- ✅ 已获取设计效果图对比
- ✅ 找到LexiHK logo文件 (`apps/web/src/assets/Lexihk-dark.png`)
- ✅ 找到书本图标文件 (`apps/web/src/assets/Vector.png`)

**实现详情**:
1. ✅ 修改 `SiderLogo` 组件，替换为 LexiHK logo
2. ✅ 移除 GitHub 星标按钮和相关逻辑
3. ✅ 将折叠按钮图标替换为书本图标 (Vector.png)
4. ✅ 调整书本图标位置至 LexiHK logo 左侧
5. ✅ 修改收缩状态下的展开按钮也使用书本图标
6. ✅ 确保侧边栏收缩后用户仍能通过书本图标重新展开
7. ✅ 修改搜索框样式：背景色改为#f1f5f8，移除所有图标，文字改为"The landlord does not return the deposit"

**修改的文件**:
- `packages/ai-workspace-common/src/components/sider/layout.tsx` - 主要侧边栏组件
- `apps/web/src/pages/canvas/index.tsx` - 画布页面收缩状态按钮
- `packages/ai-workspace-common/src/components/project/no-canvas/index.tsx` - 项目页面收缩状态按钮
- `packages/ai-workspace-common/src/components/search-quick-open-btn/index.tsx` - 搜索框组件样式修改

**测试要点**:
- 各种屏幕尺寸下的显示效果
- 深色模式的适配
- 搜索功能的正常工作
- 响应式布局的兼容性

### 需求 #003: 侧边栏宽度增加和内容简化

**需求描述**: 
增加侧边栏宽度并简化内容结构，为将来的对话记录功能预留空间

**当前行为**:
- 侧边栏宽度220px，内容包括首页/画布/知识库等全部菜单项
- 包含账号信息、订阅提示等底部内容

**期望行为**:
- 侧边栏宽度增加到300px
- 保留：书本图标 + LexiHK logo + 搜索框
- 隐藏：所有菜单项和底部内容（暂时注释，将来移到其他位置）
- 预留空间用于将来的对话记录功能（类似ChatGPT侧边栏）

**影响范围**:
- `packages/ai-workspace-common/src/components/sider/layout.tsx` - 主要侧边栏组件
- `apps/web/src/components/layout/index.tsx` - 主布局宽度计算

**技术分析**:

1. **宽度调整**:
   - 侧边栏宽度：220px → 300px
   - 主内容区域宽度：calc(100% - 200px - 16px) → calc(100% - 300px - 16px)

2. **内容简化**:
   - 注释掉所有菜单相关代码（首页、画布、知识库等）
   - 注释掉底部用户信息和订阅提示
   - 添加对话记录占位区域

3. **未来扩展预留**:
   - 在搜索框下方添加flex-1容器
   - 临时显示占位提示文字
   - 保持代码结构便于后续开发

**道德/合规考虑**:
- ✅ 纯UI结构调整，不影响用户数据
- ✅ 暂时隐藏功能，不删除代码
- ✅ 为用户体验改进做准备

**优先级**: 中
**预估工时**: 0.5天
**状态**: 已完成

**实现详情**:
1. ✅ 调整侧边栏宽度从220px到300px
2. ✅ 更新主布局的宽度计算
3. ✅ 注释掉所有菜单项和底部内容
4. ✅ 添加对话记录占位区域
5. ✅ 保持代码注释便于后续恢复

**修改的文件**:
- `packages/ai-workspace-common/src/components/sider/layout.tsx` - 侧边栏主组件
- `apps/web/src/components/layout/index.tsx` - 主布局宽度调整

**测试要点**:
- 侧边栏宽度变化后的响应式效果
- 主内容区域布局适配
- 折叠/展开功能正常工作
- 深色模式适配

### 需求 #004: 简化登录后首页交互流程

**需求描述**: 
简化登录后的用户体验，直接进入画布工作状态，移除中间的复杂AI提问界面，只保留底部简洁的输入框

**当前行为** (rightnow 截图):
- 访问 `/canvas/empty` 显示 FrontPage 组件
- 中间显示大型AI提问框、技能选择器、预设场景卡片
- 用户需要先选择技能或场景，然后输入问题，再创建画布
- 流程：首页输入 → 创建画布 → 跳转到画布页面

**期望行为** (rightfigma 截图分析):
- 访问 `/canvas/empty` 或根路径后，直接显示画布工作界面
- 移除中间的复杂UI：AI提问框、技能选择器、预设场景卡片
- 只在画布底部保留一个简洁的提问输入框
- 用户可以直接在画布环境中开始AI对话，无需额外跳转
- 流程简化为：直接进入画布 → 底部输入框交互

**影响范围**:
- 路由逻辑：`/canvas/empty` 的处理方式
- Canvas组件：需要支持无canvasId的初始状态
- EmptyGuide组件：简化或替换为底部输入框
- FrontPage组件：可能需要保留但移到其他路径
- ReflyPilot组件：可能需要调整为更简洁的底部版本

**技术分析**:

1. **核心挑战**:
   - Canvas组件目前需要真实的canvasId，但新需求希望用户直接进入"准备创建"状态
   - 需要设计一个介于"空白首页"和"已有画布"之间的中间状态

2. **实现方案思路**:
   
   **方案A: 虚拟画布模式**
   - 创建一个"虚拟画布"状态 (`canvasId = 'draft'` 或类似)
   - Canvas组件支持虚拟模式，显示空白画布 + 底部输入框
   - 用户首次提问时自动创建真实画布并无缝切换

   **方案B: 立即创建画布**
   - 用户访问 `/canvas/empty` 时立即自动创建一个空白画布
   - 直接跳转到新画布页面，用户感知不到创建过程
   - 底部显示简洁的ReflyPilot输入框

   **方案C: 新增Canvas模式**
   - 为Canvas组件添加 `mode="draft"` 属性
   - 在draft模式下显示空白画布 + 底部输入框
   - 保持现有逻辑不变，只是UI展示不同

3. **推荐方案B**: 立即创建画布
   - 用户体验最直接，无感知创建
   - 技术实现相对简单，复用现有Canvas逻辑
   - 避免虚拟状态的复杂性

4. **详细变更点**:

   **路由层面** (`apps/web/src/pages/canvas/index.tsx`):
   ```typescript
   // 当 canvasId === 'empty' 时：
   // 旧逻辑: 显示 FrontPage
   // 新逻辑: 自动创建画布并跳转，或显示特殊的Canvas模式
   ```

   **Canvas组件**:
   ```typescript
   // 需要处理空白画布的初始状态
   // 简化EmptyGuide，只显示底部输入框
   // 可能需要新的UI布局
   ```

   **底部输入框设计**:
   ```typescript
   // 类似ReflyPilot但更简洁
   // 位置固定在画布底部
   // 支持技能选择但UI更简化
   // 直接在当前画布创建节点，无需跳转
   ```

   **保留FrontPage访问**:
   ```typescript
   // 可能保留FrontPage在 /welcome 或 /getting-started 路径
   // 供需要完整功能的用户使用
   ```

5. **用户体验优化**:
   - 减少认知负担：用户不需要理解"技能"概念即可开始
   - 减少操作步骤：从"选择技能 → 输入 → 创建画布 → 跳转"变为"直接输入"
   - 保持功能完整：底部输入框仍可访问所有AI能力
   - 渐进式揭示：高级功能可通过菜单或设置访问

6. **技术风险评估**:
   - 🟡 中等风险：需要修改核心路由和Canvas逻辑
   - 🟢 兼容性好：可以通过配置控制新旧行为
   - 🟡 数据影响：可能影响画布创建统计和用户行为分析
   - 🟢 回滚友好：可以通过环境变量快速切回原始行为

**道德/合规考虑**:
- ✅ 改善用户体验，降低使用门槛
- ✅ 不影响数据隐私和安全
- ⚠️ 需要考虑新用户引导和帮助文档更新
- ⚠️ 可能需要A/B测试验证用户接受度

**优先级**: 高
**预估工时**: 2-3 天
**状态**: 进行中 - 第一阶段完成

**前置条件**:
- 需要UX设计确认底部输入框的具体交互设计
- 需要确认是否保留FrontPage的访问路径
- 需要确认自动创建画布的行为（是否影响用户配额）

**实现计划**:
1. **第一阶段**: 设计底部输入框组件和交互逻辑
2. **第二阶段**: 修改Canvas组件支持新的空白状态
3. **第三阶段**: 调整路由逻辑，实现自动画布创建
4. **第四阶段**: 用户测试和体验优化

**后续考虑**:
- 新用户引导流程设计
- 高级功能（技能选择、预设场景）的新入口设计
- 用户习惯迁移和反馈收集

### 需求 #005: 修复MCP功能（优先级：高）

**需求描述**: 
修复McpSelectorPanel组件错误，恢复MCP（Model Context Protocol）功能

**问题背景**:
- MCP是扩展AI能力的重要协议，允许AI调用外部工具和服务
- 用户明确表示后续一定需要使用MCP功能
- 当前`useListMcpServersSuspense` hook导致组件崩溃

**影响范围**:
- `packages/ai-workspace-common/src/components/canvas/launchpad/mcp-selector-panel/index.tsx`
- MCP相关的hook和查询逻辑
- 可能涉及Suspense边界配置

**技术分析**:
1. **根本原因**: Suspense hook可能缺少正确的Suspense边界或查询配置问题
2. **修复方向**:
   - 检查`useListMcpServersSuspense`的实现
   - 确保组件被正确的Suspense边界包裹
   - 修复查询参数或错误处理逻辑
   - 测试MCP服务器连接和工具加载

**优先级**: 高（用户强需求）
**预估工时**: 1-2天
**状态**: 待开始

**前置条件**:
- 先完成需求#004的底部输入框功能
- 确保基础画布功能稳定

**实现进度**:
- ✅ **第一阶段**: 自动画布创建逻辑
  - 修改 `apps/web/src/pages/canvas/index.tsx`
  - 当用户访问 `/canvas/empty` 时自动创建新画布
  - 显示加载状态："`Creating your canvas...`"
  - 保留原有 FrontPage 代码以备后用
  - 实现无感知跳转到新创建的画布页面
  - **问题修复**: 暂时禁用 McpSelectorPanel 组件中的 suspense hook，避免渲染错误
- 🔄 **待完成**: 底部简洁输入框设计和集成

**技术问题记录**:
- **⚠️ McpSelectorPanel 组件错误**: `useListMcpServersSuspense` hook 导致组件崩溃
  - 临时解决方案: 注释掉 suspense hook，使用空数据
  - 文件: `packages/ai-workspace-common/src/components/canvas/launchpad/mcp-selector-panel/index.tsx`
  - **状态**: 🔴 需要修复 - 用户确认后续一定要用MCP功能
  
**MCP（Model Context Protocol）重要性**:
- **功能定位**: 扩展AI助手能力的核心协议，允许连接外部工具和服务
- **主要用途**:
  - 实时数据访问（天气、股价、新闻等）
  - 文件系统操作（读写文件、数据处理）
  - 第三方服务集成（API调用、数据库查询）
  - 计算工具和代码执行
- **影响范围**: 
  - ✅ 基础AI对话功能不受影响
  - ❌ 实时数据查询功能受限
  - ❌ 外部工具调用功能不可用
  - ❌ 复杂文件处理功能受限

---

## 🔄 需求状态说明

- **待开始**: 需求已确认，等待开发
- **进行中**: 正在开发实现
- **待测试**: 开发完成，等待测试验证
- **已完成**: 测试通过，已部署
- **已取消**: 需求取消或废弃

## 📋 需求分析模板

每个新需求应包含以下信息：

### 基本信息
- **需求ID**: #XXX
- **需求标题**: 简洁描述
- **提出时间**: YYYY-MM-DD
- **优先级**: 高/中/低

### 需求详情
- **需求描述**: 详细说明期望实现的功能
- **当前行为**: 现有系统的行为表现
- **期望行为**: 修改后期望达到的效果
- **用户价值**: 此需求对用户的价值

### 技术分析
- **影响范围**: 列出可能受影响的模块/文件
- **技术方案**: 详细的实现方案
- **技术风险**: 可能遇到的技术难点
- **性能影响**: 对系统性能的影响评估

### 合规检查
- **数据隐私**: 是否涉及用户数据处理
- **安全风险**: 是否引入新的安全风险
- **法律合规**: 是否符合相关法律法规
- **商业道德**: 是否符合商业道德标准

### 项目管理
- **依赖关系**: 与其他需求的依赖关系
- **预估工时**: 开发时间预估
- **测试要求**: 测试范围和重点
- **发布计划**: 预期发布时间

## 🧪 测试指南

### 需求 #001 测试步骤

1. **默认行为测试** (营销首页):
   ```bash
   # 不设置环境变量或设置为 false
   VITE_HOMEPAGE_SHOW_AUTH=false pnpm dev
   # 访问 http://localhost:5173/ 应显示营销页面
   ```

2. **登录首页测试**:
   ```bash
   # 设置环境变量为 true
   VITE_HOMEPAGE_SHOW_AUTH=true pnpm dev
   # 访问 http://localhost:5173/ 应显示登录页面
   ```

3. **路由测试**:
   - 访问 `/auth` - 应始终显示登录页面
   - 访问 `/landing` - 应始终显示营销页面
   - 已登录用户访问 `/` - 应重定向到 `/canvas/empty`

4. **功能测试**:
   - 登录页面的注册/登录切换
   - OAuth 登录按钮（如果启用）
   - 邮箱登录表单验证
   - "返回首页"按钮功能

## 🚀 下一步行动

1. ✅ **需求 #001**: 首页修改已完成
2. **用户验收测试**: 确认新的登录首页用户体验
3. **性能测试**: 验证新组件的加载性能
4. **文档更新**: 更新部署文档中的环境变量说明

## 📚 相关文档

- [项目架构文档](./README.md)
- [贡献指南](./CONTRIBUTING.md)
- [部署文档](./docs/community-version/self-deploy/)

---

*文档创建时间: 2024-12-19*
*最后更新时间: 2024-12-19*

## 📈 开发进度总结

- **需求总数**: 5
- **已完成**: 3 
- **进行中**: 1
- **待开始**: 1
- **完成率**: 60% 

## 📚 开发教训记录

### 教训 #001: CSS布局理解错误 (2024-12-19)

**错误行为**:
在修复登录页面logo与表单距离问题时，错误地认为调整容器高度(h-[80px] -> h-[120px] -> h-[60px] -> h-[40px])可以解决间距问题，并且在用户明确指出错误后仍然执迷不悟，继续在错误的方向上进行调整。

**根本问题**:
- **缺乏CSS基础理解**: 没有理解flex布局中`justify-center`的作用机制
- **忽略用户反馈**: 用户明确说"改变高度解决不了问题"，但仍然坚持错误方向
- **缺乏实际查看**: 没有要求查看实际效果，凭空臆测
- **教条主义**: 过分依赖理论知识，缺乏实践验证

**正确解决方案**:
问题的核心是flex容器的对齐方式，而不是高度设置：
- `justify-center`: 让内容在主轴上居中
- `justify-start`: 让内容从起始位置开始排列
- 需要在保持整体居中的同时，合理安排内部元素间距

**经验教训**:
1. **尊重用户反馈**: 当用户明确指出技术方向错误时，应立即停止并重新分析
2. **理解问题本质**: 在CSS布局问题中，要准确识别是spacing、positioning还是alignment问题
3. **要求查看实际效果**: 进行UI修改时应该要求查看截图或实际效果
4. **承认知识盲点**: 遇到不确定的问题时，应该诚实地承认并寻求帮助
5. **学习优秀代码**: 参考现有的优秀实现(如用户提供的参考代码)比自己重新发明要高效得多

**避免策略**:
- 在进行CSS修改前，先理解当前布局的工作原理
- 用户提出技术纠正时，优先考虑用户的观点
- 对于UI问题，主动要求查看实际效果
- 学会识别自己的知识边界

**适用范围**: 所有涉及CSS布局、用户界面调整的开发任务

### 修改记录 #004: 调整搜索框与Logo间距 (2024-12-19)

**修改描述**: 
增加搜索输入框与LexiHK logo行之间的距离，让搜索框向下移动一些

**修改范围**:
- `packages/ai-workspace-common/src/components/search-quick-open-btn/index.tsx`

**具体修改**:
- 搜索框外层容器添加上边距：`mb-3` → `mb-3 mt-4`
- 上边距 `mt-4` = 16px，增加了搜索框与上方logo区域的间距

**修改原因**:
- 用户觉得搜索框与logo贴得太近，影响视觉效果
- 增加间距可以让整体布局更加美观和易读

**技术细节**:
```diff
- <div {...divProps} className={classNames('mb-3', divProps.className)}>
+ <div {...divProps} className={classNames('mb-3 mt-4', divProps.className)}>
```

**测试要点**:
- 确认搜索框与logo之间有合适的间距
- 确认整体侧边栏布局仍然协调
- 确认深色模式下效果正常

**状态**: ✅ 已完成

### 修改记录 #005: 修复核心功能缺失问题 (2024-12-19)

**问题描述**: 
在需求#003简化侧边栏后，发现原有的核心功能（如 AskAI 和创建画布）无法使用，点击后出现白屏

**根本原因**:
- 在简化侧边栏时注释掉了过多关键代码
- 移除了 `useCreateCanvas` hook 和相关的状态管理
- 缺少必要的 URL 参数处理逻辑
- 用户配置文件和模态框状态管理被注释

**修复范围**:
- `packages/ai-workspace-common/src/components/sider/layout.tsx`

**具体修复**:
1. **恢复关键导入**:
   - 添加 `useLocation`, `useSearchParams`, `useEffect` 导入
   - 恢复 `useKnowledgeBaseStoreShallow` 导入

2. **恢复核心状态管理**:
   - 恢复 `userProfile` 状态
   - 恢复模态框状态：`setShowLibraryModal`, `setShowCanvasListModal` 等
   - 恢复数据加载：`isLoadingCanvas`, `isLoadingProjects`

3. **恢复核心功能**:
   - 恢复 `useCreateCanvas` hook
   - 恢复 URL 参数处理逻辑（openLibrary, openSettings）
   - 在简化的侧边栏中添加"创建画布"按钮

4. **保持简化的UI**:
   - 仍然隐藏复杂的菜单结构
   - 保留简洁的300px宽度侧边栏
   - 只显示核心功能：logo + 搜索 + 创建画布按钮

**技术要点**:
- 区分"UI简化"和"功能移除"的概念
- 保留所有核心业务逻辑，只隐藏UI展示
- 确保 ASK AI 和画布创建等关键流程正常工作

**测试要点**:
- 确认创建画布功能正常
- 确认 ASK AI 功能正常
- 确认 URL 参数跳转正常（如 ?openLibrary=true）
- 确认不再出现白屏问题

**教训总结**:
在进行UI简化时，需要谨慎区分：
- **可以注释的**: 纯UI展示组件
- **不能注释的**: 核心业务逻辑、状态管理、事件处理

**状态**: ✅ 已完成 